<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>AR Scanner</title>
  <script src="https://aframe.io/releases/1.4.2/aframe.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.2/dist/mindar-image-aframe.prod.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore-compat.js"></script>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    html, body { 
      width: 100%; height: 100%; overflow: hidden; 
      font-family: -apple-system, BlinkMacSystemFont, sans-serif; 
      background: #000; 
      position: fixed;
      top: 0; left: 0;
    }
    
    #loading { position: fixed; inset: 0; background: #0a0a0f; display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 1000; }
    #loading.hidden { display: none; }
    #chump-anim { width: 120px; height: 120px; image-rendering: pixelated; margin-bottom: 16px; }
    
    #header { position: fixed; top: 0; left: 0; right: 0; padding: 12px 16px; padding-top: max(12px, env(safe-area-inset-top)); display: flex; justify-content: space-between; align-items: center; z-index: 100; }
    .back-btn { width: 40px; height: 40px; border-radius: 8px; background: rgba(0,0,0,0.5); backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.1); color: white; font-size: 20px; cursor: pointer; }
    .team-badge { display: flex; align-items: center; gap: 6px; padding: 6px 12px; background: rgba(0,0,0,0.5); backdrop-filter: blur(10px); border-radius: 8px; border: 1px solid rgba(255,255,255,0.1); color: white; font-size: 13px; }
    .team-dot { width: 10px; height: 10px; border-radius: 50%; }
    
    #target-info { position: fixed; top: 70px; left: 16px; right: 16px; background: rgba(0,0,0,0.6); backdrop-filter: blur(20px); border-radius: 12px; border: 1px solid rgba(255,255,255,0.1); padding: 14px; display: flex; align-items: center; justify-content: space-between; z-index: 100; opacity: 0; transform: translateY(-10px); transition: all 0.2s; pointer-events: none; }
    #target-info.found { opacity: 1; transform: translateY(0); }
    .art-title { color: white; font-size: 16px; font-weight: 600; }
    .art-sub { color: rgba(255,255,255,0.5); font-size: 12px; margin-top: 2px; }
    .points { background: #22c55e; color: white; padding: 6px 14px; border-radius: 8px; font-size: 18px; font-weight: 700; }
    .points.cooldown { background: #f59e0b; }
    
    #hint { position: fixed; bottom: 140px; left: 0; right: 0; text-align: center; color: rgba(255,255,255,0.5); font-size: 13px; z-index: 100; pointer-events: none; }
    
    #capture-area { position: fixed; bottom: 0; left: 0; right: 0; display: flex; flex-direction: column; align-items: center; padding-bottom: max(24px, env(safe-area-inset-bottom)); z-index: 200; pointer-events: none; }
    #status { margin-bottom: 12px; font-size: 13px; font-weight: 500; color: rgba(255,255,255,0.5); }
    #status.ready { color: #22c55e; }
    #status.cooldown { color: #f59e0b; }
    
    #capture-btn { 
      width: 72px; height: 72px; border-radius: 50%; 
      background: rgba(255,255,255,0.15);
      border: 3px solid rgba(255,255,255,0.3); 
      cursor: pointer; 
      opacity: 0.4; 
      transition: all 0.15s;
      pointer-events: auto;
      -webkit-tap-highlight-color: transparent;
      touch-action: manipulation;
    }
    #capture-btn.ready { 
      border-color: #22c55e; 
      background: #22c55e;
      opacity: 1; 
    }
    #capture-btn.ready:active { 
      transform: scale(0.9); 
      background: #16a34a;
    }
    #capture-btn:disabled { opacity: 0.25; pointer-events: none; }
    
    /* Success screen - dramatic animation */
    #success { position: fixed; inset: 0; display: none; align-items: center; justify-content: center; z-index: 2000; overflow: hidden; }
    #success.show { display: flex; }
    
    .success-bg { position: absolute; inset: 0; opacity: 0; animation: bgPulse 0.5s ease-out forwards; }
    @keyframes bgPulse { 0% { opacity: 0.4; } 100% { opacity: 0.2; } }
    
    .success-rays { position: absolute; inset: 0; display: flex; align-items: center; justify-content: center; }
    .ray { position: absolute; width: 4px; height: 50vh; transform-origin: bottom; opacity: 0.15; animation: rayGrow 0.4s ease-out forwards; }
    @keyframes rayGrow { 0% { transform: scaleY(0) rotate(var(--rot)); } 100% { transform: scaleY(1) rotate(var(--rot)); } }
    
    .success-content { position: relative; text-align: center; padding: 32px; animation: contentPop 0.4s cubic-bezier(0.34, 1.56, 0.64, 1) forwards; transform: scale(0) rotate(-15deg); }
    @keyframes contentPop { 0% { transform: scale(0) rotate(-15deg); } 100% { transform: scale(1) rotate(0deg); } }
    
    .success-icon { position: relative; width: 112px; height: 112px; margin: 0 auto 20px; }
    .success-glow { position: absolute; inset: 0; border-radius: 50%; filter: blur(20px); opacity: 0.5; animation: glowPulse 0.6s ease-in-out infinite alternate; }
    @keyframes glowPulse { 0% { transform: scale(1); } 100% { transform: scale(1.2); } }
    .success-circle { position: relative; width: 100%; height: 100%; border-radius: 50%; display: flex; align-items: center; justify-content: center; animation: iconBounce 0.5s ease-out 0.2s infinite; }
    @keyframes iconBounce { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.1); } }
    .success-icon-img { width: 56px; height: 56px; filter: brightness(0) invert(1); }
    
    .success-title { color: white; font-size: 36px; font-weight: 900; letter-spacing: -1px; margin-bottom: 4px; animation: slideUp 0.3s ease-out 0.1s both; opacity: 0; }
    .success-sub { color: rgba(255,255,255,0.7); font-size: 16px; font-weight: 600; margin-bottom: 20px; animation: slideUp 0.3s ease-out 0.15s both; opacity: 0; }
    @keyframes slideUp { 0% { opacity: 0; transform: translateY(20px); } 100% { opacity: 1; transform: translateY(0); } }
    
    .success-points { display: inline-flex; align-items: center; gap: 8px; padding: 8px 20px; background: rgba(0,0,0,0.4); border-radius: 100px; margin-bottom: 16px; animation: popIn 0.3s cubic-bezier(0.34, 1.56, 0.64, 1) 0.2s both; }
    .success-pts { font-size: 32px; font-weight: 900; }
    .success-streak { display: flex; align-items: center; gap: 4px; color: #f59e0b; font-weight: 700; }
    .streak-fire { font-size: 18px; }
    @keyframes popIn { 0% { transform: scale(0); } 100% { transform: scale(1); } }
    
    .success-player { display: flex; align-items: center; justify-content: center; gap: 8px; margin-bottom: 24px; animation: slideUp 0.3s ease-out 0.3s both; opacity: 0; }
    .success-player span { color: rgba(255,255,255,0.5); font-size: 14px; }
    .success-player strong { color: white; font-weight: 700; }
    .success-team-badge { padding: 4px 10px; border-radius: 4px; font-size: 11px; font-weight: 900; color: white; }
    
    .success-nav { color: rgba(255,255,255,0.3); font-size: 13px; animation: fadeIn 0.3s ease-out 0.4s both; opacity: 0; }
    @keyframes fadeIn { 0% { opacity: 0; } 100% { opacity: 1; } }
  </style>
</head>
<body>
  <div id="loading">
    <img id="chump-anim" src="animation/frame_00000.png" alt="Loading">
    <div style="color:rgba(255,255,255,0.5);font-size:13px">Loading AR...</div>
  </div>
  
  <div id="header">
    <button class="back-btn" onclick="goBack()">&larr;</button>
    <div class="team-badge"><div class="team-dot" id="team-dot"></div><span id="team-name">Team</span></div>
  </div>
  
  <div id="target-info">
    <div><div class="art-title" id="art-name">-</div><div class="art-sub" id="art-area">-</div></div>
    <div class="points" id="art-points">+0</div>
  </div>
  
  <div id="hint">Point camera at street art</div>
  
  <div id="capture-area">
    <div id="status">Searching...</div>
    <button id="capture-btn" disabled></button>
  </div>
  
  <div id="success">
    <div class="success-bg" id="s-bg"></div>
    <div class="success-rays" id="s-rays"></div>
    <div class="success-content">
      <div class="success-icon">
        <div class="success-glow" id="s-glow"></div>
        <div class="success-circle" id="s-circle">
          <img class="success-icon-img" id="s-icon-img" src="chumper.png" alt="">
        </div>
      </div>
      <div class="success-title" id="s-title">CAPTURED!</div>
      <div class="success-sub" id="s-name">-</div>
      <div class="success-points">
        <span class="success-pts" id="s-pts">+0</span>
        <div class="success-streak" id="s-streak" style="display:none"></div>
      </div>
      <div class="success-player">
        <span>by</span>
        <strong id="s-player">Player</strong>
        <span class="success-team-badge" id="s-team-badge">RED</span>
      </div>
      <div class="success-nav">Opening map...</div>
    </div>
  </div>
  
  <a-scene 
    mindar-image="imageTargetSrc: https://cdn.jsdelivr.net/gh/postptacek/street-art-ctf@main/client/public/targets.mind; maxTrack: 1; filterMinCF: 0.001; filterBeta: 100; uiLoading: no; uiScanning: no; uiError: no" 
    color-space="sRGB" 
    renderer="colorManagement: true" 
    vr-mode-ui="enabled: false" 
    device-orientation-permission-ui="enabled: false"
    loading-screen="enabled: false"
    style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 0;">
    <a-camera position="0 0 0" look-controls="enabled: false"></a-camera>
  </a-scene>
  
  <script>
    // Chump animation
    var chumpFrame = 0;
    var chumpImg = document.getElementById('chump-anim');
    setInterval(function() {
      chumpFrame = (chumpFrame + 1) % 51;
      chumpImg.src = 'animation/frame_' + String(chumpFrame).padStart(5, '0') + '.png';
    }, 42);

    firebase.initializeApp({apiKey:"AIzaSyCES_Zfi78paxI--dycL2LmBK0-g4fvvEM",authDomain:"famu-nodes.firebaseapp.com",projectId:"famu-nodes",storageBucket:"famu-nodes.firebasestorage.app",messagingSenderId:"67316044555",appId:"1:67316044555:web:72a88c28871236912f480e"});
    const db = firebase.firestore();
    // All 21 chumpster targets
    const ART = {
      'art-01':{name:'Chump 1',area:'Vysocany',points:100,loc:[50.110192,14.503811]},
      'art-02':{name:'Chump 2',area:'Vysocany',points:100,loc:[50.110203,14.503764]},
      'art-03':{name:'Chump 3',area:'Vysocany',points:100,loc:[50.109847,14.504250]},
      'art-04':{name:'Chump 4',area:'Vysocany',points:100,loc:[50.109981,14.504933]},
      'art-05':{name:'Chump 5',area:'Vysocany',points:150,loc:[50.109764,14.505742]},
      'art-06':{name:'Chump 6',area:'Vysocany',points:100,loc:[50.109672,14.505847]},
      'art-07':{name:'Chump 7',area:'Hloubetin',points:100,loc:[50.110383,14.508192]},
      'art-08':{name:'Chump 8',area:'Hloubetin',points:150,loc:[50.110508,14.509567]},
      'art-09':{name:'Chump 9',area:'Vysocany',points:100,loc:[50.110817,14.505475]},
      'art-10':{name:'Chump 10',area:'Vysocany',points:100,loc:[50.110986,14.504672]},
      'art-11':{name:'Chump 11',area:'Hloubetin',points:100,loc:[50.1105,14.5100]},
      'art-12':{name:'Chump 12',area:'Hloubetin',points:150,loc:[50.1108,14.5105]},
      'art-13':{name:'Chump 13',area:'Podebrady',points:100,loc:[50.1110,14.5110]},
      'art-14':{name:'Chump 14',area:'Podebrady',points:100,loc:[50.1112,14.5115]},
      'art-15':{name:'Chump 15',area:'Podebrady',points:150,loc:[50.1115,14.5120]},
      'art-16':{name:'Chump 16',area:'Podebrady',points:100,loc:[50.1118,14.5125]},
      'art-17':{name:'Chump 17',area:'Vysocany',points:100,loc:[50.1120,14.5130]},
      'art-18':{name:'Chump 18',area:'Vysocany',points:150,loc:[50.1122,14.5135]},
      'art-19':{name:'Chump 19',area:'Hloubetin',points:100,loc:[50.1125,14.5140]},
      'art-20':{name:'Chump 20',area:'Hloubetin',points:200,loc:[50.1128,14.5145]},
      'art-21':{name:'Chump 21',area:'Podebrady',points:200,loc:[50.1130,14.5150]}
    };
    const MAP = {0:'art-01',1:'art-02',2:'art-03',3:'art-04',4:'art-05',5:'art-06',6:'art-07',7:'art-08',8:'art-09',9:'art-10',10:'art-11',11:'art-12',12:'art-13',13:'art-14',14:'art-15',15:'art-16',16:'art-17',17:'art-18',18:'art-19',19:'art-20',20:'art-21'};
    const TARGET_COUNT = 21;
    const COOLDOWN = 10*60*1000;
    let currentId = null, canCap = false;
    const player = JSON.parse(localStorage.getItem('streetart-ctf-player')||'{}');
    const team = player.team||'red';
    const pname = player.name||'Player';
    // Generate stable player ID from name if not set
    let pid = localStorage.getItem('streetart-ctf-pid');
    if (!pid) {
      pid = 'p_' + Math.random().toString(36).substr(2, 9);
      localStorage.setItem('streetart-ctf-pid', pid);
    }
    const colors = {red:'#ff6b6b',blue:'#4dabf7'};
    console.log('Player:', pname, 'Team:', team, 'ID:', pid);
    document.getElementById('team-dot').style.backgroundColor = colors[team];
    document.getElementById('team-name').textContent = team;
    
    function goBack() { 
      window.location.href = window.location.pathname.replace('/ar-scanner.html','')+'/#/'; 
    }
    
    let isRecapture = false;
    let isFirstCapture = false;
    
    async function checkScan(id) {
      // Check cooldown for THIS PLAYER only (not shared)
      const myCooldowns = JSON.parse(localStorage.getItem('streetart-ctf-mycooldowns-'+pid)||'{}');
      if (myCooldowns[id]) {
        const t = Date.now() - myCooldowns[id];
        if (t < COOLDOWN) return {ok:false,msg:'Wait '+Math.ceil((COOLDOWN-t)/60000)+'m'};
      }
      
      // Check Firebase for current owner
      try {
        const cap = await db.collection('streetart-captures').doc(id).get();
        if (cap.exists && cap.data().capturedBy) {
          if (cap.data().capturedBy !== team) {
            isRecapture = true;
            isFirstCapture = false;
            return {ok:true,msg:'recapture'};
          }
          // Same team owns it
          isFirstCapture = false;
          isRecapture = false;
          return {ok:true,msg:null};
        }
      } catch(e) { console.log('Firebase check failed, using local'); }
      
      // Check local captures as fallback
      const localCaptures = JSON.parse(localStorage.getItem('streetart-ctf-captures')||'{}');
      if (localCaptures[id] && localCaptures[id] !== team) {
        isRecapture = true;
        isFirstCapture = false;
        return {ok:true,msg:'recapture'};
      }
      
      // First capture ever
      if (!localCaptures[id]) {
        isFirstCapture = true;
        isRecapture = false;
        return {ok:true,msg:'first'};
      }
      
      isFirstCapture = false;
      isRecapture = false;
      return {ok:true,msg:null};
    }
    
    async function capture() {
      console.log('Capture clicked! currentId:', currentId, 'canCap:', canCap);
      if (!currentId || !canCap) {
        console.log('Cannot capture - no target or not allowed');
        return;
      }
      const art = ART[currentId];
      if (!art) {
        console.log('No art data for:', currentId);
        return;
      }
      
      // Calculate streak
      const localPlayer = JSON.parse(localStorage.getItem('streetart-ctf-player')||'{}');
      const now = new Date();
      const today = now.toDateString();
      const lastCapture = localPlayer.lastCaptureTime ? new Date(localPlayer.lastCaptureTime) : null;
      const lastCaptureDay = lastCapture ? lastCapture.toDateString() : null;
      
      let currentStreak = localPlayer.streak || 0;
      if (lastCaptureDay === today) {
        // Same day - increment streak
        currentStreak += 1;
      } else {
        // New day or first capture - start streak at 1
        currentStreak = 1;
      }
      
      // Streak bonus: each capture after first gives +10% (max +50% at 6+ captures)
      const streakBonus = Math.min((currentStreak - 1) * 0.1, 0.5);
      const streakMultiplier = 1 + streakBonus;
      
      // Calculate points: first capture = 1.5x, recapture = 1.25x, normal = 1x
      let basePoints = art.points;
      let finalPoints = basePoints;
      let bonusText = '';
      
      if (isFirstCapture) {
        finalPoints = Math.round(basePoints * 1.5 * streakMultiplier);
        bonusText = 'FIRST CAPTURE +50%';
      } else if (isRecapture) {
        finalPoints = Math.round(basePoints * 1.25 * streakMultiplier);
        bonusText = 'RECAPTURED +25%';
      } else {
        finalPoints = Math.round(basePoints * streakMultiplier);
      }
      
      // Add streak info to bonus text
      if (currentStreak > 1) {
        const streakPct = Math.round(streakBonus * 100);
        bonusText = bonusText ? bonusText + ' â€¢ ' : '';
        bonusText += 'ðŸ”¥ STREAK x' + currentStreak + ' (+' + streakPct + '%)';
      }
      
      console.log('Capturing:', art.name, 'for', finalPoints, 'pts', bonusText);
      document.getElementById('capture-btn').disabled = true;
      
      // Save cooldown for THIS PLAYER only
      const myCooldowns = JSON.parse(localStorage.getItem('streetart-ctf-mycooldowns-'+pid)||'{}');
      myCooldowns[currentId] = Date.now();
      localStorage.setItem('streetart-ctf-mycooldowns-'+pid, JSON.stringify(myCooldowns));
      
      const localCaptures = JSON.parse(localStorage.getItem('streetart-ctf-captures')||'{}');
      localCaptures[currentId] = team;
      localStorage.setItem('streetart-ctf-captures', JSON.stringify(localCaptures));
      
      // Update player stats (reuse localPlayer from streak calculation)
      localPlayer.score = (localPlayer.score || 0) + finalPoints;
      localPlayer.capturedArt = [...new Set([...(localPlayer.capturedArt || []), currentId])];
      localPlayer.discoveryCount = (localPlayer.discoveryCount || 0) + 1;
      localPlayer.streak = currentStreak;
      localPlayer.maxStreak = Math.max(localPlayer.maxStreak || 0, currentStreak);
      localPlayer.lastCaptureTime = now.toISOString();
      // Track unique areas visited
      if (!localPlayer.uniqueAreasVisited) localPlayer.uniqueAreasVisited = [];
      if (!localPlayer.uniqueAreasVisited.includes(art.area)) {
        localPlayer.uniqueAreasVisited.push(art.area);
      }
      localStorage.setItem('streetart-ctf-player', JSON.stringify(localPlayer));
      
      // Check if this is a new discovery (before saving)
      const discoveries = JSON.parse(localStorage.getItem('streetart-discoveries')||'{}');
      const isNewDiscovery = !discoveries[currentId];
      
      // Save to personal discoveries (permanent collection)
      if (isNewDiscovery) {
        discoveries[currentId] = {
          artId: currentId,
          artName: art.name,
          area: art.area,
          points: finalPoints,
          discoveredAt: new Date().toISOString(),
          location: art.loc
        };
        localStorage.setItem('streetart-discoveries', JSON.stringify(discoveries));
      }
      
      localStorage.setItem('streetart-ctf-lastCapture', JSON.stringify({artId: currentId, location: art.loc, team: team}));
      
      // Try Firebase in background (don't wait)
      try {
        db.collection('streetart-captures').doc(currentId).set({
          artId: currentId, capturedBy: team, capturedAt: firebase.firestore.FieldValue.serverTimestamp(),
          playerId: pid, playerName: pname, points: finalPoints, isFirstCapture: isFirstCapture, isRecapture: isRecapture
        });
        db.collection('streetart-teams').doc(team).set({
          score: firebase.firestore.FieldValue.increment(finalPoints)
        }, {merge: true});
        db.collection('streetart-players').doc(pid).set({
          name: pname, team: team, 
          score: firebase.firestore.FieldValue.increment(finalPoints),
          captures: firebase.firestore.FieldValue.increment(1)
        }, {merge: true});
        console.log('Firebase sync attempted');
      } catch(e) { console.log('Firebase sync failed (offline mode):', e.message); }
      
      // Show dramatic success screen
      var teamColor = colors[team];
      
      // Set background and rays color
      document.getElementById('s-bg').style.backgroundColor = teamColor;
      var raysContainer = document.getElementById('s-rays');
      raysContainer.innerHTML = '';
      for (var r = 0; r < 8; r++) {
        var ray = document.createElement('div');
        ray.className = 'ray';
        ray.style.backgroundColor = teamColor;
        ray.style.setProperty('--rot', (r * 45) + 'deg');
        ray.style.animationDelay = (r * 0.03) + 's';
        raysContainer.appendChild(ray);
      }
      
      // Set icon colors
      document.getElementById('s-glow').style.backgroundColor = teamColor;
      document.getElementById('s-circle').style.backgroundColor = teamColor;
      document.getElementById('s-icon-img').style.filter = team === 'red' ? 'brightness(0) invert(1) sepia(1) saturate(5) hue-rotate(-50deg)' : 'brightness(0) invert(1)';
      
      // Set text
      document.getElementById('s-title').textContent = isNewDiscovery ? 'DISCOVERED!' : (isRecapture ? 'STOLEN!' : 'CAPTURED!');
      document.getElementById('s-name').textContent = art.name + ' Â· ' + art.area;
      document.getElementById('s-pts').textContent = '+' + finalPoints;
      document.getElementById('s-pts').style.color = teamColor;
      
      // Player info
      document.getElementById('s-player').textContent = pname;
      document.getElementById('s-team-badge').textContent = team.toUpperCase();
      document.getElementById('s-team-badge').style.backgroundColor = teamColor;
      
      // Show streak if > 1
      var streakEl = document.getElementById('s-streak');
      if (currentStreak > 1) {
        streakEl.innerHTML = '<span class="streak-fire">ðŸ”¥</span>' + currentStreak + 'x';
        streakEl.style.display = 'flex';
      } else {
        streakEl.style.display = 'none';
      }
      
      document.getElementById('success').classList.add('show');
      
      setTimeout(function() { 
        window.location.href = window.location.pathname.replace('/ar-scanner.html', '') + '/#/map'; 
      }, 2500);
    }
    
    var scene = document.querySelector('a-scene');
    
    scene.addEventListener('loaded', function() {
      console.log('Scene loaded, creating target entities...');
      var arSystem = scene.systems['mindar-image-system'];
      console.log('AR System:', arSystem);
      
      for (var i = 0; i < TARGET_COUNT; i++) {
        (function(idx) {
          var e = document.createElement('a-entity');
          e.setAttribute('mindar-image-target', 'targetIndex: '+idx);
          scene.appendChild(e);
          console.log('Created target entity:', idx);
          
          e.addEventListener('targetFound', async function() {
            console.log('TARGET FOUND:', idx);
            var id = MAP[idx]; if (!id || !ART[id]) return;
            currentId = id; var art = ART[id];
            document.getElementById('art-name').textContent = art.name;
            document.getElementById('art-area').textContent = art.area;
            var chk = await checkScan(id);
            canCap = chk.ok;
            var pts = document.getElementById('art-points');
            var btn = document.getElementById('capture-btn');
            var st = document.getElementById('status');
            if (chk.ok) { 
              // Calculate preview points
              var previewPts = art.points;
              if (chk.msg === 'first') previewPts = Math.round(art.points * 1.5);
              else if (chk.msg === 'recapture') previewPts = Math.round(art.points * 1.25);
              
              pts.textContent = '+' + previewPts; 
              pts.classList.remove('cooldown'); 
              btn.classList.add('ready'); 
              btn.disabled = false;
              
              if (chk.msg === 'first') {
                st.innerHTML = '<span style="color:#22c55e">First capture! +50%</span>';
              } else if (chk.msg === 'recapture') {
                st.innerHTML = '<span style="color:#f59e0b">Recapture! +25%</span>';
              } else {
                st.textContent = 'Tap to capture!';
              }
              st.className = 'ready'; 
            } else { 
              pts.textContent = 'WAIT'; 
              pts.classList.add('cooldown'); 
              btn.classList.remove('ready'); 
              btn.disabled = true; 
              st.textContent = chk.msg; 
              st.className = 'cooldown'; 
            }
            document.getElementById('target-info').classList.add('found');
            document.getElementById('hint').style.display = 'none';
          });
          
          e.addEventListener('targetLost', function() {
            console.log('Target lost:',idx);
            currentId = null; canCap = false;
            document.getElementById('target-info').classList.remove('found');
            document.getElementById('hint').style.display = 'block';
            document.getElementById('capture-btn').classList.remove('ready');
            document.getElementById('capture-btn').disabled = true;
            document.getElementById('status').textContent = 'Searching...';
            document.getElementById('status').className = '';
          });
        })(i);
      }
    });
    
    scene.addEventListener('arReady', function() { 
      console.log('AR Ready');
      document.getElementById('loading').classList.add('hidden'); 
    });
    
    scene.addEventListener('arError', function(e) { 
      console.error('AR Error', e);
      document.getElementById('loading').innerHTML = '<div style="color:#ff6b6b;text-align:center;padding:20px"><div style="font-size:48px;margin-bottom:16px">!</div><div>Camera access required</div><button onclick="location.reload()" style="margin-top:16px;padding:12px 24px;background:white;border:none;border-radius:8px;font-weight:bold;cursor:pointer">Retry</button></div>'; 
    });
    
    // Button click handler
    document.getElementById('capture-btn').addEventListener('click', capture);
    document.getElementById('capture-btn').addEventListener('touchend', function(e) {
      e.preventDefault();
      capture();
    });
  </script>
</body>
</html>
