#!/usr/bin/env node
/**
 * Update game files from target database
 * Usage: node update-game.js
 */

const fs = require('fs');
const path = require('path');

const TOOLS_DIR = __dirname;
const DB_FILE = path.join(TOOLS_DIR, 'targets-db.json');
const SCANNER_FILE = path.join(TOOLS_DIR, '..', 'client', 'public', 'ar-scanner.html');
const EXPORT_DIR = path.join(TOOLS_DIR, 'exports');

const SIZES = { sticker: 25, small: 50, medium: 100, large: 200 };

// Load database
if (!fs.existsSync(DB_FILE)) {
  console.error('âŒ No database found. Run target-manager.js add first.');
  process.exit(1);
}

const db = JSON.parse(fs.readFileSync(DB_FILE, 'utf8'));
console.log(`ğŸ“Š Loaded ${db.targets.length} targets from database v${db.version}\n`);

// Generate ART object code
const artEntries = db.targets.map((t, idx) => {
  const artId = t.artId || `art-${String(idx + 1).padStart(2, '0')}`;
  const pts = SIZES[t.size] || 100;
  const loc = t.lat && t.lng ? `[${t.lat},${t.lng}]` : '[0,0]';
  const name = (t.name || artId).replace(/'/g, "\\'");
  const area = (t.area || t.hood || '').replace(/'/g, "\\'");
  return `      '${artId}':{name:'${name}',area:'${area}',points:${pts},loc:${loc}}`;
}).join(',\n');

// Generate MAP object code
const mapEntries = db.targets.map((t, idx) => {
  const artId = t.artId || `art-${String(idx + 1).padStart(2, '0')}`;
  return `${idx}:'${artId}'`;
}).join(',');

const generatedCode = `    // Generated by Chump Target Manager
    // ${new Date().toISOString()}
    // Database v${db.version} - ${db.targets.length} targets
    const ART = {
${artEntries}
    };
    const MAP = {${mapEntries}};
    const TARGET_COUNT = ${db.targets.length};`;

// Update ar-scanner.html
console.log('ğŸ“ Updating ar-scanner.html...');
let scanner = fs.readFileSync(SCANNER_FILE, 'utf8');

// Find the section to replace (between firebase init and COOLDOWN)
const startPatterns = [
  /\/\/ Generated by Chump Target Manager[\s\S]*?const TARGET_COUNT = \d+;/,
  /\/\/ All art targets[\s\S]*?const TARGET_COUNT = \d+;/,
  /const ART = \{[\s\S]*?const TARGET_COUNT = \d+;/
];

let replaced = false;
for (const pattern of startPatterns) {
  if (pattern.test(scanner)) {
    scanner = scanner.replace(pattern, generatedCode);
    replaced = true;
    break;
  }
}

if (!replaced) {
  console.error('âŒ Could not find ART/MAP section in ar-scanner.html');
  console.log('   Manual paste required. Code saved to exports/ar-scanner-code.js');
} else {
  fs.writeFileSync(SCANNER_FILE, scanner);
  console.log(`âœ… Updated: ${SCANNER_FILE}`);
}

// Save export
if (!fs.existsSync(EXPORT_DIR)) fs.mkdirSync(EXPORT_DIR);
fs.writeFileSync(path.join(EXPORT_DIR, 'ar-scanner-code.js'), generatedCode);
console.log(`âœ… Saved: exports/ar-scanner-code.js`);

// Generate pragueMap.js entries for new targets with GPS
const newTargets = db.targets.filter(t => t.lat && t.lng);
if (newTargets.length > 0) {
  const mapCode = newTargets.map(t => {
    return `  { id: '${t.artId}', name: '${t.name || t.artId}', location: [${t.lat}, ${t.lng}], size: '${t.size || 'medium'}', status: 'active', mhd: null, capturedBy: null, area: '${t.area || ''}', hood: '${t.hood || ''}' },`;
  }).join('\n');
  
  fs.writeFileSync(path.join(EXPORT_DIR, 'pragueMap-code.js'), 
    `// Targets with GPS - add to ART_POINTS in pragueMap.js\n// Generated: ${new Date().toISOString()}\n\n${mapCode}`);
  console.log(`âœ… Saved: exports/pragueMap-code.js (${newTargets.length} targets with GPS)`);
}

// Generate image list for MindAR compiler
const imageList = db.targets.map((t, idx) => `${idx}: ${t.sourcePath}`).join('\n');
fs.writeFileSync(path.join(EXPORT_DIR, 'image-list.txt'), imageList);
console.log(`âœ… Saved: exports/image-list.txt`);

// Summary
console.log('\n' + 'â•'.repeat(60));
console.log('ğŸ“Š SUMMARY');
console.log('â•'.repeat(60));
console.log(`Total targets: ${db.targets.length}`);
console.log(`With GPS: ${db.targets.filter(t => t.lat && t.lng).length}`);
console.log(`Hoods: ${[...new Set(db.targets.map(t => t.hood).filter(Boolean))].join(', ')}`);

console.log('\nğŸ“‹ Target Mapping:');
db.targets.forEach((t, idx) => {
  const gps = t.lat ? 'ğŸ“' : '  ';
  console.log(`  ${gps} [${String(idx).padStart(2)}] â†’ ${t.artId || '-'} (${t.hood || '?'})`);
});

console.log('\n' + 'â•'.repeat(60));
console.log('âš ï¸  NEXT STEPS:');
console.log('â•'.repeat(60));
console.log('1. Compile .mind file:');
console.log('   â†’ Open: https://hiukim.github.io/mind-ar-js-doc/tools/compile/');
console.log('   â†’ Upload images in order from: tools/exports/image-list.txt');
console.log('   â†’ Save as: client/public/targets.mind');
console.log('');
console.log('2. Deploy:');
console.log('   cd client && npm run deploy');
console.log('');
