#!/usr/bin/env node
/**
 * Compile MindAR targets from database
 * Usage: node compile-targets.js
 */

const fs = require('fs');
const path = require('path');
const sharp = require('sharp');

// MindAR compiler (using dynamic import for ESM)
async function main() {
  const { Compiler } = await import('mind-ar/dist/mindar-image.prod.js');
  
  const TOOLS_DIR = __dirname;
  const DB_FILE = path.join(TOOLS_DIR, 'targets-db.json');
  const OUTPUT_MIND = path.join(TOOLS_DIR, '..', 'client', 'public', 'targets.mind');
  const OUTPUT_SCANNER = path.join(TOOLS_DIR, '..', 'client', 'public', 'ar-scanner.html');
  
  // Load database
  if (!fs.existsSync(DB_FILE)) {
    console.error('‚ùå No database found. Run target-manager.js first.');
    process.exit(1);
  }
  
  const db = JSON.parse(fs.readFileSync(DB_FILE, 'utf8'));
  console.log(`üìä Loaded ${db.targets.length} targets from database v${db.version}`);
  
  // Load images
  console.log('\nüì∑ Loading images...');
  const images = [];
  
  for (let i = 0; i < db.targets.length; i++) {
    const t = db.targets[i];
    if (!fs.existsSync(t.sourcePath)) {
      console.error(`‚ùå Image not found: ${t.sourcePath}`);
      process.exit(1);
    }
    
    // Load image using sharp and convert to ImageData-like format
    const img = sharp(t.sourcePath);
    const { width, height, channels } = await img.metadata();
    const buffer = await img.raw().toBuffer();
    
    // Create a simple image object that MindAR can use
    const imageData = {
      data: new Uint8ClampedArray(buffer),
      width,
      height
    };
    
    images.push({ path: t.sourcePath, width, height, buffer });
    console.log(`  [${i}] ${t.artId || '-'}: ${path.basename(t.sourcePath)} (${width}x${height})`);
  }
  
  console.log('\n‚öôÔ∏è  Compiling MindAR targets...');
  console.log('   This may take a few minutes...\n');
  
  // Compile
  const compiler = new Compiler();
  
  // Load images into compiler format
  const imageElements = [];
  for (const img of images) {
    // Create canvas-like image data
    const canvas = {
      width: img.width,
      height: img.height,
      getContext: () => ({
        drawImage: () => {},
        getImageData: () => ({
          data: img.buffer,
          width: img.width,
          height: img.height
        })
      })
    };
    
    // Create image-like object
    const imgEl = {
      width: img.width,
      height: img.height,
      naturalWidth: img.width,
      naturalHeight: img.height,
      src: img.path
    };
    
    imageElements.push(imgEl);
  }
  
  try {
    await compiler.compileImageTargets(imageElements, (progress) => {
      process.stdout.write(`\r   Progress: ${progress.toFixed(1)}%`);
    });
    console.log('\n');
    
    // Export
    const buffer = await compiler.exportData();
    fs.writeFileSync(OUTPUT_MIND, Buffer.from(buffer));
    console.log(`‚úÖ Saved: ${OUTPUT_MIND}`);
    
    // Update database
    db.lastCompiled = new Date().toISOString();
    db.compiledTargetCount = db.targets.length;
    fs.writeFileSync(DB_FILE, JSON.stringify(db, null, 2));
    
  } catch (err) {
    console.error('\n‚ùå Compilation failed:', err.message);
    console.log('\nüí° Alternative: Use the online compiler at:');
    console.log('   https://hiukim.github.io/mind-ar-js-doc/tools/compile/');
    console.log('   Upload images in the order from: tools/exports/image-list.txt');
    process.exit(1);
  }
  
  // Generate and update ar-scanner.html
  console.log('\nüìù Generating AR scanner code...');
  updateARScanner(db, OUTPUT_SCANNER);
  
  console.log('\n‚úÖ Done! Deploy with: cd client && npm run deploy');
}

function updateARScanner(db, scannerPath) {
  const SIZES = { sticker: 25, small: 50, medium: 100, large: 200 };
  
  // Generate ART object
  const artEntries = db.targets.map((t, idx) => {
    const artId = t.artId || `art-${String(idx + 1).padStart(2, '0')}`;
    const pts = SIZES[t.size] || 100;
    const loc = t.lat && t.lng ? `[${t.lat},${t.lng}]` : '[0,0]';
    const name = (t.name || artId).replace(/'/g, "\\'");
    const area = (t.area || t.hood || '').replace(/'/g, "\\'");
    return `      '${artId}':{name:'${name}',area:'${area}',points:${pts},loc:${loc}}`;
  }).join(',\n');
  
  // Generate MAP object
  const mapEntries = db.targets.map((t, idx) => {
    const artId = t.artId || `art-${String(idx + 1).padStart(2, '0')}`;
    return `${idx}:'${artId}'`;
  }).join(',');
  
  const newCode = `    // Generated by Chump Target Manager
    // ${new Date().toISOString()}
    // Database v${db.version} - ${db.targets.length} targets
    const ART = {
${artEntries}
    };
    const MAP = {${mapEntries}};
    const TARGET_COUNT = ${db.targets.length};`;
  
  // Read existing scanner
  let scanner = fs.readFileSync(scannerPath, 'utf8');
  
  // Replace the ART, MAP, TARGET_COUNT section
  const startMarker = '    // Generated by Chump Target Manager';
  const altStartMarker = '    // All art targets';
  const endMarker = 'const TARGET_COUNT =';
  
  // Find and replace
  let startIdx = scanner.indexOf(startMarker);
  if (startIdx === -1) startIdx = scanner.indexOf(altStartMarker);
  if (startIdx === -1) startIdx = scanner.indexOf('const ART = {');
  
  if (startIdx !== -1) {
    // Find the end (after TARGET_COUNT line)
    let endIdx = scanner.indexOf('const TARGET_COUNT', startIdx);
    if (endIdx !== -1) {
      endIdx = scanner.indexOf(';', endIdx) + 1;
      scanner = scanner.slice(0, startIdx) + newCode + scanner.slice(endIdx);
    }
  }
  
  fs.writeFileSync(scannerPath, scanner);
  console.log(`‚úÖ Updated: ${scannerPath}`);
  
  // Save standalone export too
  const exportPath = path.join(__dirname, 'exports', 'ar-scanner-code.js');
  fs.writeFileSync(exportPath, newCode);
  console.log(`‚úÖ Updated: ${exportPath}`);
}

main().catch(console.error);
